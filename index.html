<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Treasury Simulator — Learn Government Bonds</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
      --success:#10b981; --danger:#ef4444; --gold:#f59e0b;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071023 0%, #071024 60%);color:#e6eef6}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 32px;border-bottom:1px solid rgba(255,255,255,0.03)}
    header .brand{display:flex;align-items:center;gap:14px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021022}
    main{display:grid;grid-template-columns:320px 1fr 360px;gap:20px;padding:22px}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .sidebar .balance{font-size:20px;font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:16px}
    .nav button{background:transparent;border:0;padding:10px;border-radius:8px;color:var(--muted);text-align:left;cursor:pointer}
    .nav button.active{background:var(--glass);color:var(--accent);font-weight:600}
    .market .list{display:grid;gap:10px}
    .instrument{display:flex;justify-content:space-between;gap:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);align-items:center}
    .instrument .meta{display:flex;flex-direction:column}
    .instrument .meta small{color:var(--muted)}
    .instrument .rate{font-weight:700;font-size:16px}
    .actions button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#021022;cursor:pointer}
    .auctions .row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .countdown{font-weight:700}

    .toolbar{display:flex;gap:8px;align-items:center}
    .search{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
    .main-grid{display:grid;grid-template-rows: auto 1fr;gap:18px}
    .panel-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:14px}
    th{color:var(--muted);font-weight:600;font-size:12px}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal .sheet{width:820px;max-width:98%;background:#041224;padding:16px;border-radius:12px}

    footer{padding:18px 32px;color:var(--muted);font-size:13px}

    @media(max-width:1100px){main{grid-template-columns:1fr;}
      .right-col{order:3}
    }

    .small{font-size:12px}
    .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-weight:600}
    .chart{height:120px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px;padding:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted)}
    .danger{background:var(--danger);color:white}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">TS</div>
      <div>
        <div style="font-weight:700">Treasury Simulator</div>
        <div class="muted" style="font-size:12px">Learn how government bond auctions & trading work — simulated money</div>
      </div>
    </div>
    <div class="toolbar">
      <input class="search" id="search" placeholder="Search instruments or auctions..." />
      <div class="pill" id="clock">—</div>
      <button id="resetBtn" class="btn-ghost">Reset</button>
    </div>
  </header>

  <main>
    <aside class="card sidebar">
      <div class="balance">Balance: <span id="balanceDisplay">$1,000,000</span></div>
      <div class="muted">Cash balance (simulated)</div>
      <div style="margin-top:14px" class="muted">Portfolio value: <strong id="portfolioValue">$0</strong></div>
      <div style="margin-top:16px">
        <div class="muted">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="startSim" class="actionsBtn">Start Simulation</button>
          <button id="pauseSim" class="actionsBtn btn-ghost">Pause</button>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Navigation</div>
        <div class="nav" id="nav">
          <button class="active" data-view="market">Market</button>
          <button data-view="auctions">Auctions</button>
          <button data-view="portfolio">Portfolio</button>
          <button data-view="education">Education</button>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Upcoming Auctions</div>
        <div class="auctions" id="upcomingAuctions" style="margin-top:8px"></div>
      </div>
    </aside>

    <section class="card main-grid">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Market</h2>
        <div class="muted small">Live rates update every 5 seconds • Auctions are scheduled events</div>
      </div>

      <div style="display:flex;gap:18px">
        <div style="flex:1">
          <div class="card" id="marketCard">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="muted">Available securities</div>
              <div class="muted small">Sort by: <select id="sortBy"><option value="liquid">Liquidity</option><option value="rate">Rate</option><option value="term">Term</option></select></div>
            </div>
            <div class="market list" id="instrumentList"></div>
          </div>

          <div style="margin-top:12px" class="panel-grid">
            <div class="card">
              <div class="muted">Rate history</div>
              <div class="chart" id="rateChart">(chart)</div>
            </div>
            <div class="card">
              <div class="muted">Auction preview</div>
              <div id="auctionPreview" style="margin-top:8px">No auction selected</div>
            </div>
          </div>
        </div>

        <aside class="card right-col" style="width:360px">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="muted">Auction Now</div>
            <div class="pill" id="auctionStatus">Waiting</div>
          </div>

          <div style="margin-top:12px" id="liveAuctionCard">No live auction</div>

          <div style="margin-top:12px">
            <div class="muted">Recent activity</div>
            <div id="activityLog" style="margin-top:8px;max-height:220px;overflow:auto"></div>
          </div>
        </aside>
      </div>
    </section>

    <aside class="card" style="height:fit-content">
      <h3 style="margin-top:0">Education Corner</h3>
      <div class="muted small">Interactive guides and tooltips to learn about bills, notes, bonds, and auctions</div>
      <div style="margin-top:12px">
        <button class="btn-ghost" id="learnBtn">Start Quick Lesson</button>
      </div>

      <div style="margin-top:18px">
        <div class="muted">Shortcuts</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button class="btn-ghost" id="addFakeBids">Auto place demo bids</button>
          <button class="btn-ghost" id="fundSmall">Add $100k</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    This simulation is for educational use only. It uses simulated money and simplified clearing rules. Do not use for real trading.
  </footer>

  <div class="modal" id="modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <div id="modalContent"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="closeModal" class="btn-ghost">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Treasury Simulator — Single-file
    // Author: ChatGPT (generated)

    // -- Data models
    const defaultState = {
      cash: 1000000,
      instruments: [],
      portfolio: [],
      auctions: [],
      activity: []
    };

    // Utilities
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const fmt = (n)=>n>=1000? n.toLocaleString(undefined,{maximumFractionDigits:2}) : n.toFixed(2);
    const currency = (n)=>"$" + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const now = ()=>new Date();

    // Persistent storage
    function loadState(){
      try{
        const raw = localStorage.getItem('treasurySim_v1');
        if(raw) return JSON.parse(raw);
      }catch(e){console.error(e)}
      return defaultState;
    }
    function saveState(){ localStorage.setItem('treasurySim_v1', JSON.stringify(state)); }

    let state = loadState();

    // Seed instruments
    function seedInstruments(){
      if(state.instruments && state.instruments.length) return;
      const types = [
        {id:'T-Bill-4wk',name:'T-Bill 4wk',type:'bill',termDays:28,liquidity:9},
        {id:'T-Bill-13wk',name:'T-Bill 13wk',type:'bill',termDays:91,liquidity:9},
        {id:'T-Note-2y',name:'T-Note 2yr',type:'note',termYears:2,liquidity:8},
        {id:'T-Note-10y',name:'T-Note 10yr',type:'note',termYears:10,liquidity:6},
        {id:'T-Bond-30y',name:'T-Bond 30yr',type:'bond',termYears:30,liquidity:4},
        {id:'I-Bond',name:'I-Bond (inflation-linked)',type:'ibond',termYears:30,liquidity:6}
      ];
      const nowRateBase = { 'T-Bill-4wk': 0.015, 'T-Bill-13wk':0.018, 'T-Note-2y':0.025, 'T-Note-10y':0.035,'T-Bond-30y':0.045, 'I-Bond':0.02 };
      state.instruments = types.map(t=>({
        ...t,
        id:t.id,
        name:t.name,
        currentRate: nowRateBase[t.id] || 0.02,
        rateHistory: [],
        issueDate: new Date().toISOString(),
        price:100,
      }));
    }

    // Seed auctions schedule
    function seedAuctions(){
      if(state.auctions && state.auctions.length) return;
      const auctions = [];
      const base = Date.now();
      // schedule a few auctions in the near future relative to load time
      for(let i=1;i<=8;i++){
        const t = new Date(base + i*60*1000); // every minute for demo
        auctions.push({
          id:'AUC-'+i,
          title: i%2? '2-yr Note Auction':'10-yr Note Auction',
          instrumentId: i%2? 'T-Note-2y':'T-Note-10y',
          start: t.toISOString(),
          durationSec: 40, // auctions last 40s for demo
          bids: [],
          settled:false,
          result:null
        });
      }
      state.auctions = auctions;
    }

    // App initialisation
    seedInstruments(); seedAuctions(); saveState();

    // UI renderers
    function renderBalance(){ $('#balanceDisplay').textContent = currency(state.cash); updatePortfolioValue(); }
    function updatePortfolioValue(){
      const pv = state.portfolio.reduce((s,p)=>s + (p.quantity * (p.accruedPrice||100)),0);
      $('#portfolioValue').textContent = currency(pv);
    }

    function instrumentCard(inst){
      const div = document.createElement('div'); div.className='instrument';
      div.innerHTML = `
        <div>
          <div style="display:flex;gap:8px;align-items:center"><div style="font-weight:700">${inst.name}</div><div class="small muted">${inst.type.toUpperCase()}</div></div>
          <div class="meta"><small>Term: ${inst.termYears||''}${inst.termYears? ' yr':''}${inst.termDays? inst.termDays+' days':''}</small></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div class="rate">${(inst.currentRate*100).toFixed(3)}%</div>
          <div class="actions"><button data-id="${inst.id}" class="buyBtn">Buy</button></div>
        </div>
      `;
      return div;
    }

    function renderMarket(){
      const list = $('#instrumentList'); list.innerHTML='';
      state.instruments.forEach(inst=>{
        list.appendChild(instrumentCard(inst));
      });
      // hook buttons
      $$('.buyBtn').forEach(btn=>btn.addEventListener('click', e=>openBuyModal(e.target.dataset.id)));
    }

    function renderAuctionsList(){
      const out = $('#upcomingAuctions'); out.innerHTML='';
      state.auctions.forEach(auc=>{
        const row = document.createElement('div'); row.className='row';
        const s = new Date(auc.start);
        const cd = Math.max(0, Math.floor((s - Date.now())/1000));
        row.innerHTML = `<div style="flex:1"><div style="font-weight:700">${auc.title}</div><div class="small muted">Starts: ${s.toLocaleString()}</div></div><div style="text-align:right"><div class="countdown" data-start="${auc.start}" data-id="${auc.id}">${cd}s</div><div style="margin-top:6px"><button data-id="${auc.id}" class="joinAuc btn-ghost">View</button></div></div>`;
        out.appendChild(row);
      });
      $$('.joinAuc').forEach(b=>b.addEventListener('click', e=>openAuctionModal(e.target.dataset.id)));
    }

    function renderActivity(){
      const el = $('#activityLog'); el.innerHTML='';
      state.activity.slice().reverse().slice(0,40).forEach(a=>{
        const r = document.createElement('div'); r.style.padding='8px'; r.style.borderBottom='1px dashed rgba(255,255,255,0.02)'; r.innerHTML=`<div style="font-size:13px">${a.msg}</div><div class="muted small">${new Date(a.t).toLocaleString()}</div>`;
        el.appendChild(r);
      });
    }

    // Modal helpers
    function openModal(html){ $('#modalContent').innerHTML = html; $('#modal').classList.add('show'); }
    function closeModal(){ $('#modal').classList.remove('show'); }
    $('#closeModal').addEventListener('click', closeModal);

    // Buy flow
    function openBuyModal(instId){
      const inst = state.instruments.find(i=>i.id===instId);
      openModal(`<h3>Buy ${inst.name}</h3>
        <div class="muted">Current yield: ${(inst.currentRate*100).toFixed(3)}% • Price: $100 face (sim)</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <label>Quantity (face $100 units)</label>
          <input id="buyQty" type="number" value="10" style="width:120px;padding:8px;border-radius:6px;background:#021222;border:1px solid rgba(255,255,255,0.02);color:#e6eef6;margin-left:8px" />
        </div>
        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
          <button id="confirmBuy" class="actionsBtn">Confirm buy</button>
        </div>
      `);
      document.getElementById('confirmBuy').addEventListener('click', ()=>{
        const q = Number(document.getElementById('buyQty').value);
        const cost = q * 100; // simplified
        if(cost > state.cash){ alert('Insufficient funds'); return; }
        state.cash -= cost;
        // add to portfolio
        const existing = state.portfolio.find(p=>p.instrumentId===instId);
        const maturity = new Date(); maturity.setFullYear(maturity.getFullYear() + (inst.termYears||0));
        if(inst.termDays) maturity.setDate(maturity.getDate() + inst.termDays);
        const holding = {
          id: 'H-'+Date.now(), instrumentId:instId, name:inst.name, quantity:q, pricePaid:100, acquiredAt: new Date().toISOString(), maturity: maturity.toISOString(), accruedPrice:100, couponRate: inst.currentRate
        };
        if(existing){ existing.quantity += q; } else state.portfolio.push(holding);
        state.activity.push({t:Date.now(), msg:`Bought ${q} of ${inst.name} @ ${(inst.currentRate*100).toFixed(3)}%`});
        saveState(); renderBalance(); renderMarket(); renderPortfolio(); renderActivity(); closeModal();
      });
    }

    // Portfolio
    function renderPortfolio(){
      const rows = state.portfolio.map(p=>`<tr><td>${p.name}</td><td>${p.quantity}</td><td>${new Date(p.maturity).toLocaleDateString()}</td><td>${currency(p.pricePaid)}</td><td><button data-id="${p.id}" class="sellBtn btn-ghost">Sell</button></td></tr>`).join('') || '<tr><td colspan="5" class="muted">No holdings</td></tr>';
      openModal(`<h3>Portfolio</h3><table><thead><tr><th>Name</th><th>Qty</th><th>Maturity</th><th>Price paid</th><th></th></tr></thead><tbody>${rows}</tbody></table>`);
      $$('.sellBtn').forEach(b=>b.addEventListener('click', e=>{
        const id = e.target.dataset.id; const idx = state.portfolio.findIndex(x=>x.id===id); if(idx>=0){
          const h = state.portfolio[idx]; state.cash += h.quantity*100; state.activity.push({t:Date.now(), msg:`Sold ${h.quantity} ${h.name}`}); state.portfolio.splice(idx,1); saveState(); renderBalance(); renderActivity(); renderPortfolio();
        }
      }));
    }

    // Auctions
    function openAuctionModal(aucId){
      const auc = state.auctions.find(a=>a.id===aucId);
      if(!auc) return;
      const start = new Date(auc.start);
      const timeLeft = Math.max(0, Math.floor((start - Date.now())/1000));
      // build modal with bid form
      openModal(`<h3>${auc.title}</h3>
        <div class="muted">Instrument: ${auc.instrumentId}</div>
        <div style="margin-top:12px">Starts: ${start.toLocaleString()}</div>
        <div style="margin-top:12px">Time until start: <strong id="modalCountdown">${timeLeft}s</strong></div>
        <div style="margin-top:12px" id="bidsList">${renderBidsList(auc)}</div>
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <label style="font-weight:700">Place Bid</label>
          <input id="bidAmount" type="number" value="1000" style="width:140px;padding:8px;border-radius:6px;background:#021222;border:1px solid rgba(255,255,255,0.02);color:#e6eef6;" />
          <input id="bidYield" type="number" step="0.001" value="${(getInstrumentRate(auc.instrumentId)*100).toFixed(3)}" style="width:100px;padding:8px;border-radius:6px;background:#021222;border:1px solid rgba(255,255,255,0.02);color:#e6eef6;" />
          <button id="placeBid" class="actionsBtn">Place bid</button>
        </div>
      `);

      document.getElementById('placeBid').addEventListener('click', ()=>{
        const amt = Number(document.getElementById('bidAmount').value); const y = Number(document.getElementById('bidYield').value)/100;
        if(amt > state.cash){ alert('Insufficient funds'); return; }
        auc.bids.push({id:'B-'+Date.now(), bidder:'you', amt, yield:y, t:new Date().toISOString()});
        state.cash -= amt; state.activity.push({t:Date.now(), msg:`Placed bid ${currency(amt)} @ ${(y*100).toFixed(3)}% for ${auc.title}`}); saveState(); renderActivity();
        // refresh bids list
        document.getElementById('bidsList').innerHTML = renderBidsList(auc);
      });

      // countdown updater for modal
      const modalTimer = setInterval(()=>{
        const left = Math.max(0, Math.floor((new Date(auc.start) - Date.now())/1000));
        const el = document.getElementById('modalCountdown'); if(el) el.textContent = left + 's';
        if(left<=0){ clearInterval(modalTimer); // auction starting — automatically close modal
          closeModal(); openLiveAuction(aucId);
        }
      },1000);

    }

    function renderBidsList(auc){
      if(!auc.bids.length) return '<div class="muted">No bids yet</div>';
      return '<div style="max-height:200px;overflow:auto">'+auc.bids.map(b=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02)">${b.bidder} • ${currency(b.amt)} @ ${(b.yield*100).toFixed(3)}% • <span class="muted small">${new Date(b.t).toLocaleTimeString()}</span></div>`).join('')+'</div>';
    }

    function openLiveAuction(aucId){
      const auc = state.auctions.find(a=>a.id===aucId); if(!auc) return;
      // show live auction panel in right column
      $('#auctionStatus').textContent = 'Live';
      $('#liveAuctionCard').innerHTML = `<div style="padding:12px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-weight:700">${auc.title}</div><div class="muted">Instrument: ${auc.instrumentId}</div><div style="margin-top:8px">Time remaining: <span id="liveTimer">${auc.durationSec}s</span></div><div style="margin-top:8px"><div id="liveBids" style="max-height:140px;overflow:auto"></div></div><div style="margin-top:8px"><button id="autoBidBtn" class="btn-ghost">Auto-place demo bid</button></div></div>`;
      document.getElementById('autoBidBtn').addEventListener('click', ()=>{
        placeAutoBid(aucId);
      });

      // auction countdown
      let tLeft = auc.durationSec;
      const liveTimer = setInterval(()=>{
        tLeft--; if(tLeft<=0){ clearInterval(liveTimer); settleAuction(aucId); $('#auctionStatus').textContent='Waiting'; $('#liveAuctionCard').innerHTML='No live auction'; return; }
        $('#liveTimer').textContent = tLeft + 's';
        $('#liveBids').innerHTML = renderBidsList(auc);
      },1000);

      // reveal existing bids in UI
      $('#liveBids').innerHTML = renderBidsList(auc);
    }

    function placeAutoBid(aucId){
      const auc = state.auctions.find(a=>a.id===aucId);
      const instRate = getInstrumentRate(auc.instrumentId);
      const yieldOffer = instRate + (Math.random()-0.5)*0.015; // random +/-
      const amt = Math.round( (1000 + Math.random()*9000) );
      auc.bids.push({id:'B-'+Date.now(), bidder:'demo-'+Math.floor(Math.random()*1000), amt, yield:yieldOffer, t:new Date().toISOString()});
      state.activity.push({t:Date.now(), msg:`Demo auto bid ${currency(amt)} @ ${(yieldOffer*100).toFixed(3)}%`}); saveState(); renderActivity();
    }

    function settleAuction(aucId){
      const auc = state.auctions.find(a=>a.id===aucId);
      if(!auc || auc.settled) return;
      // Simple clearing rule: take weighted average yield of bids; allocate proportionally
      if(!auc.bids.length){ state.activity.push({t:Date.now(), msg:`Auction ${auc.title} closed with no bids.`}); auc.settled=true; saveState(); renderActivity(); return; }
      const totalAmt = auc.bids.reduce((s,b)=>s+b.amt,0);
      const weightedYield = auc.bids.reduce((s,b)=>s + b.yield * b.amt,0)/totalAmt;
      // allocate: assume total issuance 100k face units
      const issuance = 100000;
      // assign allocations to bidders proportionally to their amt
      auc.result = {clearingYield:weightedYield, allocations: auc.bids.map(b=>({bidder:b.bidder, allocated: Math.round((b.amt/totalAmt)*issuance)})), totalAmt};
      // credit holdings for 'you' bids only
      auc.result.allocations.forEach(a=>{
        if(a.bidder==='you'){
          const inst = getInstrument(auc.instrumentId);
          const qty = a.allocated;
          const maturity = new Date(); maturity.setFullYear(maturity.getFullYear() + (inst.termYears||0)); if(inst.termDays) maturity.setDate(maturity.getDate()+inst.termDays);
          const holding = {id:'H-'+Date.now()+Math.random(), instrumentId:inst.id, name:inst.name, quantity:qty, pricePaid:100, acquiredAt:new Date().toISOString(), maturity: maturity.toISOString(), accruedPrice:100, couponRate: auc.result.clearingYield }
          state.portfolio.push(holding);
          state.activity.push({t:Date.now(), msg:`Auction allocation: received ${qty} units of ${inst.name} @ ${(auc.result.clearingYield*100).toFixed(3)}%`});
        }
      });
      // refund demo bidders (we had deducted only your bid funds earlier); for demo bidders we did not deduct
      auc.settled = true; saveState(); renderActivity();
    }

    function getInstrument(id){ return state.instruments.find(i=>i.id===id); }
    function getInstrumentRate(id){ const i = getInstrument(id); return i? i.currentRate:0.02; }

    // Market dynamics: update rates every 5s
    function startMarketLoop(){
      if(window.marketInterval) return;
      window.marketInterval = setInterval(()=>{
        // random walk for rates
        state.instruments.forEach(inst=>{
          const delta = (Math.random()-0.5)*0.0008 * (inst.liquidity? (1/inst.liquidity):1); // smaller moves for liquid
          inst.currentRate = Math.max(0, inst.currentRate + delta);
          inst.rateHistory.push({t:Date.now(), rate:inst.currentRate});
          if(inst.rateHistory.length>160) inst.rateHistory.shift();
        });
        saveState(); renderMarket(); updateRateChart(); renderAuctionsList(); renderClock();
      },5000);
    }
    function stopMarketLoop(){ clearInterval(window.marketInterval); window.marketInterval=null; }

    // Rate chart (simple sparkline)
    function updateRateChart(){
      const el = $('#rateChart'); el.innerHTML='';
      const canvas = document.createElement('canvas'); canvas.width = el.clientWidth; canvas.height = el.clientHeight; el.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      // plot 10-year rate history
      const inst = state.instruments.find(x=>x.id==='T-Note-10y') || state.instruments[0];
      const arr = inst.rateHistory.length? inst.rateHistory.map(r=>r.rate) : [inst.currentRate];
      const w = canvas.width, h=canvas.height; ctx.lineWidth=2; ctx.beginPath();
      const min = Math.min(...arr); const max = Math.max(...arr);
      arr.forEach((v,i)=>{
        const x = i*(w/Math.max(1,arr.length-1)); const y = h - ((v-min)/(max-min||1))*h;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.strokeStyle = '#60a5fa'; ctx.stroke();
    }

    // Clock and countdowns
    function renderClock(){ $('#clock').textContent = new Date().toLocaleTimeString(); // update auction countdowns
      $$('.countdown').forEach(el=>{ const start = new Date(el.dataset.start); const left = Math.max(0, Math.floor((start - Date.now())/1000)); el.textContent = left + 's'; }); }

    // Buttons
    $('#startSim').addEventListener('click', ()=>{ startMarketLoop(); state.activity.push({t:Date.now(), msg:'Simulation started'}); saveState(); renderActivity(); });
    $('#pauseSim').addEventListener('click', ()=>{ stopMarketLoop(); state.activity.push({t:Date.now(), msg:'Simulation paused'}); saveState(); renderActivity(); });
    $('#resetBtn').addEventListener('click', ()=>{ if(confirm('Reset simulation to defaults?')){ localStorage.removeItem('treasurySim_v1'); location.reload(); } });
    $('#learnBtn').addEventListener('click', ()=>{
      openModal('<h3>Quick Lesson: Auctions</h3><p class="muted">Auction types: Competitive bidding (you specify yield) and non-competitive (you accept clearing yield). This simulator uses a simple competitive model where bids are placed and a clearing yield is calculated as the weighted average of all bids.</p>');
    });
    $('#addFakeBids').addEventListener('click', ()=>{ // place demo bids on upcoming auctions
      state.auctions.forEach(a=>{ a.bids.push({id:'D-'+Date.now()+Math.random(), bidder:'demo-'+Math.floor(Math.random()*999), amt:1000+Math.floor(Math.random()*9000), yield: getInstrumentRate(a.instrumentId) + (Math.random()-0.5)*0.02, t:new Date().toISOString()}); }); saveState(); renderActivity(); renderAuctionsList(); alert('Placed demo bids'); });
    $('#fundSmall').addEventListener('click', ()=>{ state.cash += 100000; saveState(); renderBalance(); state.activity.push({t:Date.now(), msg:'Added $100k to account (demo)'}); renderActivity(); });

    // Navigation
    $$('#nav button').forEach(b=>b.addEventListener('click', e=>{
      $$('#nav button').forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); const view = e.target.dataset.view; if(view==='market'){ /* show market */ openModal('<h3>Market view</h3><div class="muted">Use the main UI to interact</div>'); } else if(view==='auctions'){ renderAuctionsList(); openModal('<h3>Auctions</h3><div class="muted">See upcoming auctions. Click View to participate.</div>'); } else if(view==='portfolio'){ renderPortfolio(); } else if(view==='education'){ openModal('<h3>Education</h3><div class="muted">Read about the different securities here.</div>'); }
    }));

    // periodic housekeeping for auctions starting in background
    setInterval(()=>{
      const soon = state.auctions.filter(a=> !a.settled && (new Date(a.start) <= new Date()));
      soon.forEach(a=>{
        // if not yet live, start live automatically
        if(!a.live && !a.settled){ a.live = true; openLiveAuction(a.id); }
      });
      // remove old auctions >1h past
      saveState(); renderAuctionsList(); renderActivity(); renderClock();
    },1000);

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{ if(e.key==='/' && document.activeElement.tagName!=='INPUT'){ e.preventDefault(); $('#search').focus(); } });

    // initial render
    renderBalance(); renderMarket(); renderAuctionsList(); renderActivity(); updateRateChart(); renderClock();

    // start loop automatically
    startMarketLoop();

    // expose some functions for debugging
    window.TS = { state, saveState }
  </script>
</body>
</html>
